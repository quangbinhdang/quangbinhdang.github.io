<!DOCTYPE html>
<html>
<head>
  <title>Page Title</title>
  <style>
  table, th, td {
   border: 1px solid;
   border-collapse: collapse;
 }

</style>

</head>
<body>

  <h1>Welcome to magic calculator</h1>
  <p id="demo">Upload your race source</p>

  <form enctype="multipart/form-data">
    <input id="file" type=file   accept=".txt" name="files[]" size=30>
  </form>
  <p id="track_distance"></p>
  <p id="track_condition"></p>
  <table id="horses_table" class="sortable">
   <thead>
     <tr>
       <th id="Name" onclick="sortTable(0)">Name</th>
       <th id="SaddleNumber" onclick="sortTable(1)">Number</th>
       <th id="Age" onclick="sortTable(2)">Age</th>
       <th id="Barrier" onclick="sortTable(3)">Barrier</th>
       <th id="PrizeMoneyWon" onclick="sortTable(4)">Prize money</th>
       <th onclick="sortTable(5)">Speed</th>
       <th id="Weight" onclick="sortTable(6)">Weight</th>
       <th onclick="sortTable(7)">Jockey</th>
       <th onclick="sortTable(8)">Track win percentage</th>
       <th onclick="sortTable(9)">Track place percentage</th>
       <th onclick="sortTable(10)">T/D win percentage</th>
       <th onclick="sortTable(11)">T/D place percentage</th>
       <th onclick="sortTable(12)">Win percentage</th>
       <th onclick="sortTable(13)">Place percentage</th>
       <th onclick="sortTable(14)">Average prize</th>
       <th onclick="sortTable(15)">Form</th>
       <th onclick="sortTable(16)">Steve&Co points</th>
     </tr>
   </thead>
   <tbody id="horses_table_body">
   </tbody>
 </table>
</body>
</html>

<!-- <script src="https://www.kryogenix.org/code/browser/sorttable/sorttable.js"></script> -->

<script type="text/javascript">

  (function(){

    function onChange(event) {
      var reader = new FileReader();
      reader.onload = onReaderLoad;
      reader.readAsText(event.target.files[0]);
    }

    function onReaderLoad(event){
      var obj = JSON.parse(event.target.result);
      process_race(obj, 'Name');
    }
    
    function process_race(info, sortBy = null){
    var race = info.props.pageProps.initialReduxState.race;
    var raceDistance = race.Distance;
    var raceCondition = race.Meeting.TrackCondition;
    var state = race.Meeting.State;
    var horses = race.Runners;

    var pointsCellArray = [];
    var averagePrizeArray = [];
    var availableHorses = [];

     document.getElementById('track_distance').innerHTML = "Track distance: " + raceDistance;
     document.getElementById('track_condition').innerHTML = "Track condition: " + raceCondition;
     var table = document.getElementById("horses_table_body");
     horses.forEach((horse) => {
       var status = horse.Status;
       if(status != "Scratched"){
        availableHorses.push(horse);
        // Create an empty <tr> element and add it to the 1st position of the table:
        var row = table.insertRow();
        // Insert new cells (<td> elements) at the 1st and 2nd position of the "new" <tr> element:
        var nameCell = row.insertCell();
        var saddleNumberCell = row.insertCell();
        var ageCell = row.insertCell();
        var barrierCell = row.insertCell();
        var prizeMoneyCell = row.insertCell();
        var speedCell = row.insertCell();
        var weightCell = row.insertCell();
        var jockeyCell = row.insertCell();

        var trackWinPercentCell = row.insertCell();
        var trackPlacePercentCell = row.insertCell();

        var trackDistanceWinPercentCell = row.insertCell();
        var trackDistancePlacePercentCell = row.insertCell();

        var winPercentCell = row.insertCell();
        var placePercentCell = row.insertCell();
        var averagePrizeMoneyCell = row.insertCell();
        var formCell = row.insertCell();

        var steveCoPointsCell = row.insertCell();
        pointsCellArray.push(steveCoPointsCell);

        // horse info 
        var name = horse.Name;
        var age = horse.Age;
        var sex = horse.Sex;
        var barrier = horse.Barrier;
        var prizeMoney = horse.PrizeMoneyWon;
        var speed = horse.SpeedMap.Speed;
        var weight = horse.totalWeight;
        var jockey = horse.Jockey.Name;
        var saddleNumber = horse.SaddleNumber;

        var trackPerformanceWinPercentage = Math.round((horse.stats.trackPerformance.wins/horse.stats.trackPerformance.starts)*100);
        var trackPerformancePlacePercentage = Math.round(((horse.stats.trackPerformance.wins + horse.stats.trackPerformance.seconds)/horse.stats.trackPerformance.starts) * 100);

        var distancePerformanceWinPercentage = Math.round((horse.stats.distancePerformance.wins/horse.stats.distancePerformance.starts)*100);
        var distancePerformancePlacePercentage = Math.round(((horse.stats.distancePerformance.wins + horse.stats.distancePerformance.seconds)/horse.stats.distancePerformance.starts) * 100);

        var trackDistanceWinPercentage = Math.round((horse.stats.trackAndDistancePerformance.wins/horse.stats.trackAndDistancePerformance.starts) * 100);
        var trackDistancePlacePercentage = Math.round(((horse.stats.trackAndDistancePerformance.wins+horse.stats.trackAndDistancePerformance.seconds)/horse.stats.trackAndDistancePerformance.starts)  * 100);

        var winPercentage = horse.stats.winPercent;
        var placePercentage = horse.stats.placePercent;

        nameCell.innerHTML = name;
        ageCell.innerHTML = age;
        saddleNumberCell.innerHTML = saddleNumber;
        barrierCell.innerHTML = barrier;
        prizeMoneyCell.innerHTML = Math.round(prizeMoney * 100);
        speedCell.innerHTML = speed;
        weightCell.innerHTML = weight;
        jockeyCell.innerHTML = jockey;

        trackWinPercentCell.innerHTML = trackPerformanceWinPercentage;
        trackPlacePercentCell.innerHTML = trackPerformancePlacePercentage;

        trackDistanceWinPercentCell.innerHTML = trackDistanceWinPercentage;
        trackDistancePlacePercentCell.innerHTML = trackDistancePlacePercentage;

        winPercentCell.innerHTML = winPercentage;
        placePercentCell.innerHTML = placePercentage;

        var averagePrizeMoney = Math.round(prizeMoney/horse.stats.allPerformance.starts);
        averagePrizeArray.push(averagePrizeMoney);
        
        averagePrizeMoneyCell.innerHTML = Math.round(averagePrizeMoney * 100);
        var formBonus = 0;
        var previousForms = horse.PreviousForm;
        previousForms.forEach(form => {

          if(form.Finish <= 3){
              if(jockey.toLowerCase() == form.Jockey){
                formBonus += 5;
              }
              if(barrier == form.Barrier){
                formBonus += 3;
              } else if(barrier == (form.Barrier + 1) || barrier == (form.Barrier - 1)) {
                formBonus += 2;
              } else if (barrier == (form.Barrier + 2) || barrier == (form.Barrier - 2)){
                formBonus += 1;
              } else {
                formBonus -= 3;
              }

              if(raceDistance == form.Distance){
                  formBonus += 5;
              }

              if(Number(form.StartingPrice) > 30 && Number(form.Margin) < 0.5){
                  formBonus += 5;
              }

              if(form.RacePrizeMoney > 5000000){
                  formBonus += 15;
              } else if(form.RacePrizeMoney > 3000000) {
                  formBonus += 13;
              } else if(form.RacePrizeMoney > 1000000) {
                  formBonus += 10;
              } else if(form.RacePrizeMoney > 800000) {
                  formBonus += 9;
              } else if(form.RacePrizeMoney > 500000) {
                  formBonus += 7;
              } else if(form.RacePrizeMoney > 200000) {
                  formBonus += 5;
              } else if(form.RacePrizeMoney > 100000) {
                  formBonus += 4;
              } else if(form.RacePrizeMoney > 70000) {
                  formBonus += 3;
              } else if(form.RacePrizeMoney > 50000) {
                  formBonus += 2;
              } else if(form.RacePrizeMoney > 20000) {
                  formBonus += 1;
              }
          }
          if(form.Finish == 1){
            formBonus += 5;
          } else if (form.Finish == 2){
            formBonus += 3;
          } else if(form.Finish == 3){
            formBonus += 1;
          } else if(form.Finish == form.NumberOfRunners){
              formBonus -= 5;
          } else if(form.Finish > (form.NumberOfRunners/2)){
            formBonus -= 3;
          } else if (form.Finish > (form.NumberOfRunners/3)){
            formBonus -= 1;
          }

          var formDistance = form.Distance;
          if(formDistance == raceDistance && form.TimeRan != "N/A" && form.Finish <= 3){
            var timeRan = form.TimeRan;
            var finish = form.Finish;
            var margin = form.Margin;
            var timeArray = timeRan.split(":");
            var minute = timeArray[0]; 
            var secondArray = timeArray[1].split(".");

            var second = secondArray[0];
            var mili = secondArray[1];

            var miliToWin = Number(mili);
            // Margin Bonus to time, 0.1L = 5ms
            miliToWin += Number(form.Margin) * 10 * 5;
            console.log("000 miliToWin == " + miliToWin);
            //Barrier Bonus to time, 1 Barrier = 33ms
            var barrierDiffirence = Number(form.Barrier) - Number(barrier);
            miliToWin += Number(barrierDiffirence * 33);
            console.log("1111 miliToWin == " + miliToWin);
            // Weight Bonus to time, 1kg = 50ms
            weight = weight.replace('kgs', '');
            console.log("2222 miliToWin == " + miliToWin);
            var weightDifference = Number(form.BodyWeight) + Number(form.WeightCarried) - Number(weight);
            console.log("form.BodyWeight = " + form.BodyWeight + "form.WeightCarried = " + form.WeightCarried + "| weight = " + weight + " | weightDifference = " + weightDifference + " | ADDED = " + Number(weightDifference * 50));

            miliToWin += Number(weightDifference * 50);
            console.log("3333 miliToWin == " + miliToWin);
            var secondToWin = Math.floor(miliToWin/100);

            if(miliToWin < 0){
              miliToWin = 100 + (miliToWin % 100);
            }

            
            var remainingMiliToWin = miliToWin % 100;
            second = Number(second) + Number(secondToWin);
            mili = Number(remainingMiliToWin);
            var expectedWinTime = minute + ":" + second + "." + mili;
            console.log("minute = " + timeArray[0] + " second = " + second + " mili = " + remainingMiliToWin);
            var formInfo = "Finish: " + finish + "/" + form.NumberOfRunners + "<br/>Time: " + timeRan + "</br>Expected Time: "+ expectedWinTime + "<br/>Margin: " + margin + "<br/>----------------<br/>";
            formCell.innerHTML += formInfo;
          }

        });

        // MARK: Logic
        // Bonus on jockeys
        var jockeyBonus = getJockeyPoints(jockey, state);
        var speedBarrierBonus = 0;
        var speedDistanceBonus = 0;
        var trackBonus = 0;
        var distanceBonus = 0;
        var trackDistanceBonus = 0;
        var ageBonus = 0;
        if(isNaN(trackPerformanceWinPercentage) || trackPerformanceWinPercentage == 0 || trackPerformancePlacePercentage < 50){
            trackBonus -= 10;
        } else {
          trackBonus += Math.round(trackPerformanceWinPercentage/10);
        }
        if(isNaN(trackPerformancePlacePercentage) || trackPerformanceWinPercentage == 0 || trackPerformancePlacePercentage < 50){
            distanceBonus = -10;
        } else {
          distanceBonus += Math.round(trackPerformancePlacePercentage/10);
        }

        if(isNaN(trackDistancePlacePercentage)  || trackDistanceWinPercentage == 0|| trackDistancePlacePercentage < 50){
            trackDistanceBonus = -10;
        } else {
          trackDistanceBonus += Math.round(trackDistancePlacePercentage/10);
        }


        if(barrier < 5) { 
          speedBarrierBonus = speed - barrier;
        }
        if(raceDistance <= 1100){
            speedDistanceBonus = speed;
        }

        if(age >= 4 < 7){
            ageBonus += 3;
        } else if(age > 3 &&  age < 8) {
            ageBonus += 1;
        } else {
          ageBonus -= 3;
        }
        console.log("jockeyBonus: " + jockeyBonus + " || speedBarrierBonus: " + speedBarrierBonus + " || speedDistanceBonus: " + speedDistanceBonus + " || distanceBonus: " + distanceBonus + " || trackDistanceBonus: " + trackDistanceBonus + " || formBonus: " + formBonus);
        var bonus = jockeyBonus + speedBarrierBonus + speedDistanceBonus + distanceBonus + trackDistanceBonus + formBonus + ageBonus;
        // var totalPoints = bonus + penalty;
        steveCoPointsCell.innerHTML = bonus; 
      }
    });
    averagePrizeArray.sort((a, b) => a - b);
    console.log("AVERAGE PRIZE = " + averagePrizeArray);
    console.log("horses= " + horses.length);
    averagePrizeArray.forEach(function(prize, prizeIndex){

      availableHorses.forEach(function(horse, horseIndex){
        var prizeMoney = horse.PrizeMoneyWon;
        var averagePrizeMoney = Math.round(prizeMoney/horse.stats.allPerformance.starts);
        if(averagePrizeMoney == prize){
          console.log("horseIndex: " + horseIndex);
            var points = Number(pointsCellArray[horseIndex].innerHTML);
            console.log("points: " + points + " || prize bonus: " + prizeIndex);
            console.log("total: " + Number(points + prizeIndex));

            pointsCellArray[horseIndex].innerHTML = Number(points + prizeIndex);
        }
      });
    });
   }

   function getJockeyPoints(jockey, state) {
     console.log("Jock = " + jockey + " | State = " + state)
     switch(state.toLowerCase()) {
       case "Nsw".toLowerCase():
        // code block
        switch(jockey){
          case "James McDonald".toLowerCase():    return 20;
          case "William Pike".toLowerCase():    return 20;
          case "Ashley Morgan".toLowerCase():     return 19;
          case "Hugh Bowman".toLowerCase():       return 18;
          case "James McDonald".toLowerCase():    return 17;
          case "Jason Collett".toLowerCase():     return 16;
          case "Tommy Berry".toLowerCase():       return 15;
          case "Dylan Gibbons".toLowerCase():     return 14;
          case "Mathew Cahill".toLowerCase():     return 13;
          case "Reece Jones".toLowerCase():       return 12;
          case "Grant Buckley".toLowerCase():     return 11;
          case "Tim Clark".toLowerCase():         return 10;
          case "Winona Costin".toLowerCase():     return 9;
          case "Brodie Loy".toLowerCase():        return 8;
          case "Ben Looker".toLowerCase():        return 7;
          case "Jackson Searle".toLowerCase():    return 6;
          case "Jeff Penza".toLowerCase():        return 5;
          case "Brooke Stower".toLowerCase():     return 4;
          case "Aaron Bullock".toLowerCase():     return 3;
          case "Christian Reith".toLowerCase():   return 2;
          case "Mikayla Weir".toLowerCase():      return 1;
          default: return 0;
        }
        break;
        case "Vic".toLowerCase():
        switch(jockey.toLowerCase()){
         case "Damian Lane".toLowerCase():    return 20;
         case "J Allen".toLowerCase():    return 19;
         case "Jye McNeil".toLowerCase():       return 18;
         case "Damien Thornton".toLowerCase(): return 17;
         case "Jordan Childs".toLowerCase():    return 16;
         case "Jason Collett".toLowerCase():    return 15;
         case "Jarrod Fry".toLowerCase():       return 14;
         case "Craig Newitt".toLowerCase():     return 13;
         case "Patrick Moloney".toLowerCase():      return 12;
         case "Will Gordon".toLowerCase():    return 11;
         case "Zac Spain".toLowerCase():        return 10;
         case "Jamie Kah".toLowerCase():    return 9;
         case "Damien Oliver".toLowerCase():        return 8;
         case "Michael Dee".toLowerCase():        return 7;
         case "Beau Mertens".toLowerCase():     return 6;
         case "Blaike McDougall".toLowerCase():     return 6;
         case "Brett Prebble".toLowerCase():    return 5;
         case "Declan Bates".toLowerCase():         return 5;
         case "Josh Richards".toLowerCase():    return 4;
         case "Jack Hill".toLowerCase():    return 3;
         case "Craig Williams".toLowerCase():   return 2;
         case "Dean Holland".toLowerCase():       return 1;
         default: return 0;
       }
        // code block
        break;
       case "WA".toLowerCase():
       switch(jockey.toLowerCase()){
        case "Clint Johnston-Porter".toLowerCase():     return 20;
        case "Chris Parnham".toLowerCase():     return 19;
        case "Natasha Faithfull".toLowerCase():     return 18;
        case "Holly Watson".toLowerCase():      return 17;
        case "Brad Rawiller".toLowerCase():     return 16;
        case "Shaun O'Donnell".toLowerCase():     return 15;
        case "Troy Turner".toLowerCase():       return 14;
        case "Joseph Azzopardi".toLowerCase():    return 13;
        case "Jason Whiting".toLowerCase():     return 12;
        case "Shaun McGruddy".toLowerCase():      return 11;
        case "Lucy Warwick".toLowerCase():    return 10;
        case "Laqdar Ramoly".toLowerCase():     return 9;
        case "Patrick Carbery".toLowerCase():         return 8;
        case "Keshaw Dhurun".toLowerCase():     return 7;
        case "Brad Parnham".toLowerCase():        return 6;
        case "Kyra Yuill".toLowerCase():        return 5;
        case "Lisa Staples".toLowerCase():    return 4;
        case "Andrew Castle".toLowerCase():         return 3;
        case "Jade McNaught".toLowerCase():     return 2;
        case "Jordan Turner".toLowerCase():     return 1;
        default: return 0;
      }
      break;
      case "SA".toLowerCase():
      switch(jockey.toLowerCase()){
       case "Kayla Crowther".toLowerCase():     return 20;
       case "Barend Vorster".toLowerCase():     return 19;
       case "Ben Price".toLowerCase():    return 18;
       case "Jake Toeroek".toLowerCase():       return 17;
       case "Jason Holder".toLowerCase():     return 16;
       case "Angus Chung".toLowerCase():    return 15;
       case "Ryan Hurdle".toLowerCase():      return 14;
       case "Todd Pannell".toLowerCase():     return 13;
       case "Paul Gatt".toLowerCase():    return 12;
       case "Dom Tourneur".toLowerCase():       return 11;
       case "Justin Potter".toLowerCase():    return 10;
       case "Jacob Opperman".toLowerCase():     return 9;
       case "Ellis Wong".toLowerCase():         return 8;
       case "Karl Zechner".toLowerCase():     return 7;
       case "Teagan Voorham".toLowerCase():         return 6;
       case "Jessica Eaton".toLowerCase():        return 5;
       case "Anna Jordsjo".toLowerCase():     return 4;
       case "Sophie Logan".toLowerCase():         return 3;
       case "Jeffrey Maund".toLowerCase():    return 2;
       case "Stacey Callow".toLowerCase():    return 1;
       default: return 0;
     }
     default:
     return 0;
   }
 }

 function displayHorses(horses) {
   document.getElementById('track_condition').innerHTML = "Track condition: " + horses;
      // var string = JSON.stringify(horses)
      // var array = JSON.parse(horses);
      // var horse = horses[0].Name;
      console.log(horses);
      // alert(horses);
      // for(var i in array){
     //        console.log(i);
     //    }

     horses.forEach((horse) => {
      console.log("Horse = " + horse);
    });

  //    // Find a <table> element with id="myTable":    var table = document.getElementById("horses_table");
    // for(var horse in horses) {
    //  console.log("horse")
    //    // Create an empty <tr> element and add it to the 1st position of the table:
  //      var row = table.insertRow(0);
  //      // Insert new cells (<td> elements) at the 1st and 2nd position of the "new" <tr> element:
  //      var nameCell = row.insertCell(0);
  //      var winPercentCell = row.insertCell(1);
  //      var placePercentCell = row.insertCell(2);
  //      cell1.innerHTML = horse.Name;
    // }
  }

  document.getElementById('file').addEventListener('change', onChange);

  const th = document.getElementsByTagName('th')
  for (var i = 0; i < th.lenth; i++) {
   console.log(th[i])
   th[i].addEventListener('click', function (event) {
    let element = event.target || event.srcElement
    console.log(element.id)
  })
 }
}());

</script>

<script>
  function sortTable(n) {
    var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
    table = document.getElementById("horses_table");
    switching = true;
  // Set the sorting direction to ascending:
  dir = "asc";
  /* Make a loop that will continue until
  no switching has been done: */
  while (switching) {
    // Start by saying: no switching is done:
    switching = false;
    rows = table.rows;
    /* Loop through all table rows (except the
    first, which contains table headers): */
    for (i = 1; i < (rows.length - 1); i++) {
      // Start by saying there should be no switching:
      shouldSwitch = false;
      /* Get the two elements you want to compare,
      one from current row and one from the next: */
      x = rows[i].getElementsByTagName("TD")[n];
      y = rows[i + 1].getElementsByTagName("TD")[n];
      /* Check if the two rows should switch place,
      based on the direction, asc or desc: */
      console.log("MYTEST = " + isNaN(x.innerHTML) + " || " + isNaN(y.innerHTML));
      if(!isNaN(x.innerHTML) && !isNaN(y.innerHTML)){
       if (dir == "asc") {
         if (Number(x.innerHTML) > Number(y.innerHTML)) {
           shouldSwitch = true;
           break;
         }

       } else if (dir == "desc") {
        if (Number(x.innerHTML) < Number(y.innerHTML)) {
         shouldSwitch = true;
         break;
       }

     }

   } else {
    console.log("GO HERER!!!!!");
    if (dir == "asc") {
      if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
              // If so, mark as a switch and break the loop:
              shouldSwitch = true;
              break;
            }
         } else if (dir == "desc") {
          if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
            // If so, mark as a switch and break the loop:
            shouldSwitch = true;
            break;
          }
        }
      }


    //   if (dir == "asc") {
       //  if (Number(x.innerHTML) > Number(y.innerHTML)) {
        //  shouldSwitch = true;
        //  break;
        // }
    //     // if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
    //     //   // If so, mark as a switch and break the loop:
    //     //   shouldSwitch = true;
    //     //   break;
    //     // }
    //   } else if (dir == "desc") {
      //   if (Number(x.innerHTML) < Number(y.innerHTML)) {
        //  shouldSwitch = true;
        //  break;
        // }
    //     // if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
    //     //   // If so, mark as a switch and break the loop:
    //     //   shouldSwitch = true;
    //     //   break;
    //     // }
    //   }
  }
  if (shouldSwitch) {
      /* If a switch has been marked, make the switch
      and mark that a switch has been done: */
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
      // Each time a switch is done, increase this count by 1:
      switchcount ++;
    } else {
      /* If no switching has been done AND the direction is "asc",
      set the direction to "desc" and run the while loop again. */
      if (switchcount == 0 && dir == "asc") {
        dir = "desc";
        switching = true;
      }
    }
  }
}
</script>